<!DOCTYPE html>
<head>

	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src="https://d3js.org/d3-queue.v3.min.js"></script>
	<script src="jnd/lib/d3.min.js"></script>
	<script src="https://d3js.org/d3-axis.v1.min.js"></script>
	<script src="src/scalar.js"></script>
	<script src="design/src/colormap.js"></script>
	<script src="design/src/gl_pipeline.js"></script>
	<script src="design/src/coloranalysis.js"></script>
	<script src="jnd/lib/three.min.js"></script>
	<script src="jnd/src/gaussmix.js"></script>
	<script src="jnd/src/scalar_sample.js"></script>
	<script src="jnd/src/lineup.js"></script>

	<style>
		body {font-family: arial; font-size: 15px;}
		.modelPath {fill: none; stroke-width: 3px;}
		button {font-size: 15px;}

		.sliderDiv {
			width: 80px;
			height: 5px;
			font-size: 10px;
		}

	</style>
</head>
<body>

	<div>
		<p>edit model<br>
		<p><button onclick="addX()">add X</button>&nbsp;&nbsp;<button onclick="removeX()">remove X</button><br>
		<button onclick="addY()">add Y</button>&nbsp;&nbsp;<button onclick="removeY()">remove Y</button><br>
		<p><button onclick="copyToDecoy()">perturb decoy</button> &nbsp;&nbsp;

		<p><button onclick="randomLineup()" style="background-color: #d9ff66">new linup (or press ENTER)</button>
		&nbsp;&nbsp;<button onclick="randomModel()" style="background-color: #ffe0b3">random model</button>

		<p><table>
			<tr>
				<td>lineup sampling fidelity</td>
				<td><div class="uiDiv sliderDiv" id="sliderN"></div></td>
				<td><span id="sliderNValue"></span></td>
			</tr>
			<tr>
				<td colspan="3"><input type="checkbox" id="checkDecoy" onclick="toggleHighlightDecoy()"></input>highlight decoy position
			</tr>

			<tr>
				<td colspan="3"><input type="checkbox" id="checkPerturbDecoy" checked></input>randomly pertub decoy model a bit
			</tr>


		</table>

	</div>
	<div style="margin-top: 10px; height: 310px">
	<div style="position: relative;">
		<svg width="550" height="300" style="position: absolute; top: 0px; left: 0px;">
			<!-- a transparent grey drop-shadow that blends with the background colour -->
			<defs>
			<filter id="dropshadow" x="0" y="0" width="200%" height="200%">
		      <feOffset result="offOut" in="SourceAlpha" dx="20" dy="20" />
		      <feGaussianBlur result="blurOut" in="offOut" stdDeviation="10" />
		      <feBlend in="SourceGraphic" in2="blurOut" mode="normal" />
		    </filter>
			</defs>


			<g transform="translate(50,50)">
				<g id="models"></g>
			</g>

			<g transform="translate(300,50)"
				<g id="decoyModel"></g>
			</g>
		</svg>

		<svg width="200" height="300" id="svgColormaps" style="position: absolute; top: 0px; left: 550px;"></svg>

		<canvas id="mainCanvas" width="200" height="200" style="z-index: 10; position: absolute; top: 50px; left: 50px; border: solid 1px black;">
		</canvas>

		<canvas id="decoyCanvas" width="200" height="200" style="z-index: 10; position: absolute; top: 50px; left: 300px; border: solid 1px black;">
		</canvas>
	</div>
	</div>

	<div>
		click on the picture below that doesn't belong. <span id="answer"></span>
		<table cellspacing="3" cellpadding="3" id="lineupTable">
		</table>
	</div>

	<script>
		// dimensions of samples
		var WIDTH=150;
		var HEIGHT=150;
		var ROTATE = false;

		// number of samples per pixel
		var goodN = 10*WIDTH*HEIGHT;
		var N=12000;
		var lineupN = 6;

		function copyToDecoy()
		{
			var CENTER_PERTURB = .1/2;
			var DENSITY_PERTURB = 4;	// of maxiumum weight

			var perturb = d3.select("#checkPerturbDecoy").node().checked;
			mainModel.copyTo(decoyModel, perturb);

			if (perturb)
			{
				// TODO: find a more principled approach of doing this (e.g., residual rotation)
				var maxXDensity = decoyModel.modelMaxX;
				var maxYDensity = decoyModel.modelMaxY;

				for (var i=0; i<decoyModel.models.length; i++) {
					var m = decoyModel.models[i];
					var c = m.axis=='x' ? WIDTH : HEIGHT;
						c *= (Math.random()*2-1) * CENTER_PERTURB;
					var d = m.axis=='x' ? maxXDensity : maxYDensity;
						d *= (Math.random()*2-1) * DENSITY_PERTURB;
					m.param[0] += c;
					m.param[2] += d;

					// don't bother perturbing the SD for now
				}
				decoyModel.updateModel();
			}
			decoyModel.fireCallbacks();

		}

		// one "main" and one decoy model
		var mainModel = new GaussMix(WIDTH, HEIGHT, d3.select("#models"));
		mainModel.init();
		var mainSample = new ScalarSample(WIDTH, HEIGHT, d3.select('#mainCanvas').node());
		mainSample.setSamplingFidelity(goodN);
		mainSample.setModel(mainModel);

		var decoyModel = new GaussMix(WIDTH, HEIGHT, d3.select("#decoyModel"));
		copyToDecoy();
		var decoySample = new ScalarSample(WIDTH, HEIGHT, d3.select("#decoyCanvas").node());
		decoySample.setSamplingFidelity(goodN);
		decoySample.setModel(decoyModel);

		function randomLineup()
		{
			// new lineup
			var start = Date.now();
			if (lineup)
			{
				lineup.sample();
				lineup.layoutCanvases(d3.select("#lineupTable"));
			}
			console.log("lineup took: " + Math.floor(Date.now() - start) + " milliseconds");

			// hide answer
			d3.select("#answer").html('');
			d3.select('#lineupTable').selectAll('canvas').on('click', function()
			{
				console.log('clicked lineup canvas');
				d3.select("#answer").html('<font color="red"><b>Incorrect</b></font>');
			})

			d3.select('#sample' + (lineupN-1)).on('click', function()
			{
				d3.select("#answer").html('<font color="green"><b>Correct!</b></font>');
			})
		}
		// create lineup
		var lineup = new Lineup(WIDTH, HEIGHT, lineupN, mainModel, decoyModel);
		randomLineup();

		function randomModel()
		{
			var start = Date.now();
			mainModel.init(true);
			copyToDecoy();
			refreshModel();
			console.log('model took: ' + Math.floor(Date.now()-start) + ' milliseconds');
		}

		function refreshModel()
		{
			mainSample.sampleAndVis();
			decoySample.sampleAndVis();
			refreshStimulus();
		}

		function refreshStimulus()
		{
			N = +$('#sliderN').slider('value');
			randomLineup();
		}

		function toggleHighlightDecoy() {
			var check = d3.select("#checkDecoy").node().checked;
			d3.select("#sample" + (lineupN-1))
				.style("border", check ? 'solid 3px red' : null);
		}

		function showColormaps() {
			var COLORMAPS = [
				'viridis', 'rainbowjet', 'turbo', 'coolwarm', 'spectral'
			];
			var MAP_W=100, MAP_H=15, MAP_PAD=5;
			d3.select('#svgColormaps').selectAll('image').data(COLORMAPS)
				.enter().append('image')
				.attr('x', function(d, i) { return 20; })
				.attr('y', function(d, i) {
					return i*(MAP_H+MAP_PAD);
				})
				.attr('width', MAP_W)
				.attr('height', MAP_H)
				.attr('xlink:href', function(d, i) {
					var colormap = getColorPreset(d, null, null);
					var canvas = colormap.drawColorScale(MAP_W, MAP_H, MAP_W, 'horizontal');
					return canvas.toDataURL("image/png");
				})
				.on('click', function(d) {
					ScalarSample.setUniversalColormap(getColorPreset(d));
				});

			d3.select('#svgColormaps').selectAll('text').data(COLORMAPS)
				.enter().append('text')
				.attr('x', function(d, i) { return 20 + MAP_W + 10; })
				.attr('y', function(d, i) {
					return 12+ i*(MAP_H+MAP_PAD);
				})
				.html(function(d) { return d});

		}

		function initInterface()
		{
			d3.select("#mainCanvas")
				.attr('width', WIDTH)
				.attr('height', HEIGHT);

			d3.select("#decoyCanvas")
				.attr('width', WIDTH)
				.attr('height', HEIGHT);

			function sampleAndPlotModel()
			{
				console.log("draw model");
				mainModel.sampleModel(N, field);
			}

			// keyboard events
			d3.select(document).on('keydown', function() {
				if (d3.event.keyCode === 13) {
					randomLineup();
				}
			});

			// sliders
			$('#sliderN').slider({ step: 10, min: 300, max: goodN/15, value: N, change: refreshStimulus, slide: function(event, ui) { d3.select("#sliderNValue").html(ui.value);} });

			showColormaps();
		}

		function addX() { mainModel.add('x'); refreshModel(); }
		function addY() { mainModel.add('y'); refreshModel(); }

		function removeX() { mainModel.remove('x');  refreshModel();}
		function removeY() { mainModel.remove('y');  refreshModel();}

		initInterface();
	</script>

</body>
</html>
