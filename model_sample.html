<!DOCTYPE html>
<head>

	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src="https://d3js.org/d3-queue.v3.min.js"></script>
	<script src="jnd/lib/d3.min.js"></script>
	<script src="https://d3js.org/d3-axis.v1.min.js"></script>
	<script src="src/scalar.js"></script>
	<script src="design/src/colormap.js"></script>
	<script src="design/src/gl_pipeline.js"></script>
	<script src="design/src/coloranalysis.js"></script>
	<script src="jnd/lib/three.min.js"></script>
	<script src="jnd/src/gaussmix.js"></script>

	<style>
		body {font-family: arial; font-size: 15px;}
		.modelPath {fill: none; stroke-width: 3px;}
		button {font-size: 15px;}
	</style>
</head>
<body>

	<p>edit model<br>
	<button onclick="addX()">add X</button>&nbsp;&nbsp;<button onclick="removeX()">remove X</button><br>
	<button onclick="addY()">add Y</button>&nbsp;&nbsp;<button onclick="removeY()">remove Y</button><br>

	<div style="position: relative">
		<svg width="500" height="500" style="position: absolute; top: 0px; left: 0px; border: solid 1px black">
			<g transform="translate(50,100)">
				<g id="models"></g>
			</g>
		</svg>

		<canvas id="visCanvas" width="300" height="300" style="z-index: 10; position: absolute; top: 100px; left: 50px; border: solid 1px black;">
		</canvas>

	</div>

	<script>
		var WIDTH=200;
		var HEIGHT=200;

		var mainModel = new GaussMix(WIDTH, HEIGHT, d3.select("#models"));
		mainModel.init();

		// create a new scalar field
		var field=new ScalarField(WIDTH, HEIGHT);

		// number of samples per pixel
		var N=100;

		// a visualizaiton pipeline
		var visualizer = null;
		function visualizeField(_field)
		{

		}

		function initVis()
		{
			d3.select("#visCanvas")
				.attr('width', WIDTH)
				.attr('height', HEIGHT);

			// shaders
			var shaderList = [
				{name: 'vis',		path: 'design/src/shaders/vis.frag'},
				{name: 'vertex',	path: 'design/src/shaders/vertex.vert'},
				{name: 'blur',		path: 'design/src/shaders/blur.frag'}
			];

			function pipelineReady(__field)
			{
				/*
				console.log("pipeline ready");
				var visBlurPipeline = new GLPipeline(visualizer.glCanvas);
				visBlurPipeline.addStage({
					uniforms: {
						scalarField: {},
						colormap: {},
						contour: {value: -1.0}
						//pitch: {value: [1/__field.w, 1/__field.h]}
					},
					inTexture: 'scalarField',
					fragment: visualizer.shaders['vis'],
					vertex: visualizer.shaders['vertex']
				});
				visualizer.pipelines = {
					blur: visBlurPipeline
				};
				*/

				visualizer.createVisPipeline();
			}

			function sampleAndDrawModel()
			{
				console.log("draw model");
				mainModel.sampleModel(N, field);

				// render scatterplot
				if (visualizer.ready())
				{
					// make sure the field has an associated colormap
					if (!field.getColorMap()) {
						// if not, use viridis as default
						field.setColorMap(getColorPreset('viridis', null, null, true))
					}
					visualizer.run('vis');
				}

			}


			// if first time, create the visualizer
			if (!visualizer) {
				visualizer = new ColorAnalysis(
					field,
					d3.select("#visCanvas").node(),
					function() {pipelineReady(field);}, shaderList
				)
			}
			mainModel.setCallback(sampleAndDrawModel);

		}

		function addX() { mainModel.add('x'); }
		function addY() { mainModel.add('y'); }

		function removeX() { mainModel.remove('x'); }
		function removeY() { mainModel.remove('y'); }

		initVis();
	</script>

</body>
</html>
