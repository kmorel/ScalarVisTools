<html>
<head>

	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src="https://d3js.org/d3-queue.v3.min.js"></script>
	<script src="jnd/lib/d3.min.js"></script>
	<script src="jnd/lib/three.min.js"></script>

	<script src="src/scalar.js"></script>
	<script src="src/perlin.js"></script>
	<script src="src/noisegen.js"></script>

	<script src="design/src/colormap.js"></script>
	<script src="design/src/gl_pipeline.js"></script>
	<script src="design/src/coloranalysis.js"></script>

	<script src="jnd/src/2afc.js"></script>
	
	<style>
		body {
			background-color: #eeeeee;
			font-family: Helvetica;
			font-size: 14px;

			/* disable selection */
			-webkit-user-select: none;
			-moz-user-select: -moz-none;
			-ms-user-select: none;
			user-select: none;
		}

		.uiParentDiv {
			margin-bottom: 10px;
			vertical-align: middle;
		}
		.uiDiv {
			width: 80px;
			display: inline-block;
		}

		.sliderDiv {
			width: 80px;
			height: 5px;
			font-size: 10px;
		}

		#stimLeft {}
		#stimRight {}

	</style>
</head>

<body>
	<div style="width: 600px; margin:0 auto;">
		<div style="margin-bottom: 20px">
			<div class="uiParentDiv">
			
				<div class="uiDiv">Gradient<br>magnitude</div>
				<div class="uiDiv sliderDiv" id="sliderMagnitude"></div>
				<div class="uiDiv" id="sliderMagnitudeValue"></div>

			</div>
			
			<div class="uiParentDiv">

				<div class="uiDiv">Diff</div>
				<div class="uiDiv sliderDiv" id="sliderDiff"></div>
				<div class="uiDiv" id="sliderDiffValue"></div>
			</div>

		</div>

		<div style="border: solid 1px red; width: 250px; float: left">
			<canvas id="stimLeft" width="250" height="250"></canvas>
		</div>
		<div style="border: solid 1px blue; width: 250px; float: right">
			<canvas id="stimRight" width="250" height="250"></canvas>
		</div>
	</div>

	<script type="text/javascript">
		var STIM_W = 250;
		var STIM_H = 250;

		var stimMagnitude = 1;
		var stimDiff = 0.7;

		var stimulus = new TAFC(STIM_W, STIM_H);
		var visLeft, visRight;
		var colormapLeft, colormapRight;

		function refreshStimulus()
		{
			var magnitude = +$('#sliderMagnitude').slider('value');
			var diff = $('#sliderDiff').slider('value');

			d3.select("#sliderMagnitudeValue").html(magnitude);
			d3.select("#sliderDiffValue").html(diff);

			stimulus.randomStimulus(magnitude, diff);

			// visualize the 2AFC images
			visLeft.run('vis');
			visRight.run('vis');	
		}


		function createUI() {
			$('#sliderMagnitude').slider({ step: 0.01, min: 0.01, max: 10, value: stimMagnitude, change: refreshStimulus });

			$('#sliderDiff').slider({ step: 0.01, min: 0.01, max: 2, value: stimMagnitude, change: refreshStimulus });
		}

		function initExperiment()
		{
			var shaderList = [
				{name: 'vis',		path: 'design/src/shaders/vis.frag'},
				{name: 'vertex',	path: 'design/src/shaders/vertex.vert' }
			];
			function createVisLeft(callback) {
				visLeft = new ColorAnalysis(
					stimulus.getFirst(),
					d3.select("#stimLeft").node(),
					function() {callback(null);}, shaderList
				);
			}

			function createVisRight(callback) {
				visRight = new ColorAnalysis(
					stimulus.getSecond(),
					d3.select("#stimRight").node(),
					function() {callback(null);}, shaderList
				);
			}

			var q = d3.queue()
				.defer( createVisLeft )
				.defer( createVisRight )
				.awaitAll(function(error, results)
				{
					if (error) { 
						throw error;
					}
					else
					{
						// create vis pipelines
						visLeft.createVisPipeline();
						visRight.createVisPipeline();

						// initialize colormaps
						colormapLeft = 	getColorPreset('coolwarm', null, null, true);
						colormapRight = getColorPreset('coolwarm', null, null, true);
						stimulus.getFirst().setColorMap(colormapLeft);
						stimulus.getSecond().setColorMap(colormapRight);


						// continue loading
						createUI();
					}
				});

			
 	
		}

		//createUI();
		initExperiment();
	</script>
</body>
</html>