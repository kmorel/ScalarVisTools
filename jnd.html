<html>
<head>

	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src="https://d3js.org/d3-queue.v3.min.js"></script>
	<script src="jnd/lib/d3.min.js"></script>
	<script src="https://d3js.org/d3-axis.v1.min.js"></script>

	<script src="jnd/lib/three.min.js"></script>

	<script src="src/scalar.js"></script>
	<script src="src/perlin.js"></script>
	<script src="src/noisegen.js"></script>
	<script src="src/terrain.js"></script>

	<script src="design/src/colormap.js"></script>
	<script src="design/src/gl_pipeline.js"></script>
	<script src="design/src/coloranalysis.js"></script>

	<script src="jnd/src/2afc.js"></script>
	
	<style>
		body {
			background-color: #eeeeee;
			font-family: Helvetica;
			font-size: 14px;

			/* disable selection */
			-webkit-user-select: none;
			-moz-user-select: -moz-none;
			-ms-user-select: none;
			user-select: none;
		}

		.uiParentDiv {
			margin-bottom: 10px;
			vertical-align: middle;
		}
		.uiDiv {
			width: 80px;
			display: inline-block;
		}

		.sliderDiv {
			width: 80px;
			height: 5px;
			font-size: 10px;
		}
		.distRect {
			fill: #cccccc;
			stroke: #333333;
			stroke-width: 1px;
		}

		#stimLeft {}
		#stimRight {}

	</style>
</head>

<body>
	<div style="width: 600px; margin:0 auto;">
		<div style="margin-bottom: 20px">
			<div class="uiParentDiv">
			
				<div class="uiDiv">Gradient<br>magnitude</div>
				<div class="uiDiv sliderDiv" id="sliderMagnitude"></div>
				<div class="uiDiv" id="sliderMagnitudeValue"></div>

			</div>
			
			<div class="uiParentDiv">

				<div class="uiDiv">Diff</div>
				<div class="uiDiv sliderDiv" id="sliderDiff"></div>
				<div class="uiDiv" id="sliderDiffValue"></div>
			</div>

			<div class="uiParentDiv">

				<div class="uiDiv">Exponent</div>
				<div class="uiDiv sliderDiv" id="sliderExponent"></div>
				<div class="uiDiv" id="sliderExponentValue"></div>
			</div>


		</div>

		<div style="border: solid 1px red; width: 257px; float: left">
			<canvas id="stimLeft" width="256" height="256"></canvas>
			<br>
			<svg id="svgLeft" width="256" height="350" style="border: dashed 1px black"></svg>
		</div>
		<div style="border: solid 1px blue; width: 257px; float: right">
			<canvas id="stimRight" width="256" height="256"></canvas>
			<br>
			<svg id="svgRight" width="256" height="350" style="border: dashed 1px black"></svg>

		</div>
	</div>

	<script type="text/javascript">
		var STIM_W = 256;
		var STIM_H = 256;
		var HIST_W = 150;
		var HIST_H = 150;
		var HIST_OFFSET = 50;


		var stimMagnitude = 1;
		var stimDiff = 0.7;

		var stimulus = new TAFC(STIM_W, STIM_H);
		var visLeft, visRight;
		var colormapLeft, colormapRight;

		function visualizeDist(svg, dist, theMax)
		{
			if (!theMax) {
				theMax = d3.max(dist);
			}
			var yScale = d3.scaleLinear()
				.domain([0, theMax])
				.range([HIST_H, 0]);

			var g = svg.append('g');

			var update = g.selectAll('rect.distRect').data(dist);
			update = update.enter().append('rect')
				.attr('class', 'distRect')
				.merge(update);
			update
				.attr('x', function(d, i) { return (HIST_W / dist.length) * i; })
				.attr('y', function(d, i) { return (yScale(d)); })
				.attr('width', function() { return HIST_W / dist.length; })
				.attr('height', function(d) {
					return HIST_H - yScale(d);
				});

			// plot the scale
			var gScale = g.append('g');
			var axis = d3.axisLeft(yScale);

			gScale.call(axis);

			g.attr('transform', 'translate(' + HIST_OFFSET + ',30)').attr('class', 'distribution');
			return g;
		}



		function refreshStimulus()
		{
			var timeStart = Date.now();

			var magnitude = +$('#sliderMagnitude').slider('value');
			var diff = $('#sliderDiff').slider('value');
			var expWeight = $('#sliderExponent').slider('value');
			setExponentWeight(expWeight);

			d3.select("#sliderMagnitudeValue").html(magnitude);
			d3.select("#sliderDiffValue").html(diff);
			d3.select("#sliderExponentValue").html(getExponentWeight());

			stimulus.randomStimulus(magnitude, diff);

			// visualize the 2AFC images
			visLeft.run('vis');
			visRight.run('vis');

			// visualize the distributions
			d3.select('#svgLeft').selectAll('g.distribution').remove();
			d3.select('#svgRight').selectAll('g.distribution').remove();
			
			var dist1 = stimulus.getFirstDist();
			var dist2 = stimulus.getSecondDist();
			var maxValue = Math.max(d3.max(dist1), d3.max(dist2));
			
			// visualize distributions
			visualizeDist(d3.select("#svgLeft"), dist1, maxValue);
			visualizeDist(d3.select("#svgRight"), dist2, maxValue);
			
			// run a KS test and plot a qq plot
			var ksTest = KS_test(stimulus.stim1.view, stimulus.stim2.view);
			
			d3.select("#svgLeft").select("g.qqplot").remove();
			var gPlot = d3.select('#svgLeft').append('g')
				.attr('class', 'qqplot')
				.attr('transform', 'translate(' + HIST_OFFSET + ',' + (40 + HIST_H + 10) + ')');

			plotQQ(gPlot, HIST_W, 120, ksTest.field1, ksTest.field2, ksTest.valueAtMax)


			printTimeDiff(timeStart, Date.now(), "time")
		}


		function createUI() {
			$('#sliderMagnitude').slider({ step: 0.01, min: 0.01, max: 10, value: stimMagnitude, change: refreshStimulus });

			$('#sliderDiff').slider({ step: 0.05, min: 0.0, max: 12, value: stimMagnitude, change: refreshStimulus });

			$('#sliderExponent').slider({ step: 0.05, min: .1, max: 10, value: getExponentWeight(), change: refreshStimulus });

		}

		function initExperiment()
		{
			var shaderList = [
				{name: 'vis',		path: 'design/src/shaders/vis.frag'},
				{name: 'vertex',	path: 'design/src/shaders/vertex.vert' }
			];
			function createVisLeft(callback) {
				visLeft = new ColorAnalysis(
					stimulus.getFirst(),
					d3.select("#stimLeft").node(),
					function() {callback(null);}, shaderList
				);
			}

			function createVisRight(callback) {
				visRight = new ColorAnalysis(
					stimulus.getSecond(),
					d3.select("#stimRight").node(),
					function() {callback(null);}, shaderList
				);
			}

			var q = d3.queue()
				.defer( createVisLeft )
				.defer( createVisRight )
				.defer( loadExternalColorPresets )
				.awaitAll(function(error, results)
				{
					if (error) { 
						throw error;
					}
					else
					{
						// create vis pipelines
						visLeft.createVisPipeline();
						visRight.createVisPipeline();

						// initialize colormaps
						colormapLeft = 	getColorPreset('spectral', null, null, true);
						colormapRight = getColorPreset('spectral', null, null, true);
						stimulus.getFirst().setColorMap(colormapLeft);
						stimulus.getSecond().setColorMap(colormapRight);

						// continue loading
						createUI();
					}
				});

			
 	
		}

		var TEAMS = [
			{
				key: "ARI",
				values: [
					{key: "W", values: 49},
					{key: "L", values: 30},
					{key: "T", values: 1}

				]
			},
			{
				key: "ATL",
				values: [
					{key: "W", values: 39},
					{key: "L", values: 41}
				]
			}
		];

		for (var i=0; i < TEAMS.length; i++) {
			var team = TEAMS[i];
			team.map = d3.map(team.values, function(d) { return d.key; })
		}

		// example use: TEAMS[1].map.get("W")

		var TeamMap = d3.map(TEAMS, function(d) { return d.key; });
		// example use: TeamMap.get("ATL").map.get("W")
		
		//createUI();
		initExperiment();
	</script>
</body>
</html>