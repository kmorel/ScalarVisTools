<html>
<head>

	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src="https://d3js.org/d3-queue.v3.min.js"></script>


	<script src="design/lib/three.js"></script>
	<script src="design/lib/d3.js"></script>
	<script src="design/lib/d3-color.v1.min.js"></script>
	<script src="design/lib/d3-interpolate.v1.min.js"></script>

	<script src="src/perlin.js"></script>
	<script src="design/src/gl_pipeline.js"></script>
	<script src="design/src/scalar.js"></script>
	<script src="design/src/noisegen.js"></script>
	<script src="design/src/terrain.js"></script>
	<script src="design/src/coloranalysis.js"></script>
	<script src="design/src/colormath.js"></script>
	
	<!-- design tool -->
	<script src="design/src/picker.js"></script>
	<script src="design/src/colormap.js"></script>
	<script src="design/src/colorramp.js"></script>


	<style>
		body {
			background-color: #eeeeee;
			font-family: Helvetica;
			font-size: 14px;

			/* disable selection */
			-webkit-user-select: none;
			-moz-user-select: -moz-none;
			-ms-user-select: none;
			user-select: none;
		}

		.controlPoint {
			fill: #f4d142;
			stroke: black;
			stroke-width: 1px;
		}

		.colorPatch {
			stroke: black;
			stroke-width: 0px;
		}
		.selectedColorPatch {
			stroke: black; stroke-width: 2px;
		}

		.controlPointConnection {
			stroke: #aaaaaa;
			stroke-width: 1px;
		}

		.down {
			background-color: green;
		}

		.luminancePlot {
			stroke: black; stroke-width: 1px;
			fill: none;
		}

		.diffPlot {
			stroke: red; stroke-width: 1px;
			fill: none;
		}

	</style>

</head>

<body style="margin: 0 0">
	<div style="padding: 15 15; background-color: #333333; color: white; text-align: center">
		<span style="font-size: 35px; font-weight: 100"><i>Colour</i>Map</span>
	</div>

	<div style="margin: 15 15">
		<div>
			<!--Color picker<br>-->
			<div style="float: left">
				<div id="pickedColor" style="width: 40px; height: 40px; margin-bottom: 5px; float: left"></div>
				<div id="previewColor" style="width: 40px; height: 40px; margin-bottom: 5px; margin-left: 0px; float: left"></div>
				<div style="float: right; font-size: 13px">
					<label for="colorspaceLab">Lab</label>
					<input type="radio" name="colorspace" id="colorspaceLab" checked="checked">
					<label for="colorspaceRGB">RGB</label>
					<input type="radio" name="colorspace" id="colorspaceRGB">
				</div>

				<div>
					<canvas id="colorCanvas" width="275" height="275" style="border: solid 1px black"></canvas>
					<canvas id="channelCanvas" width="30" height="275" style="border: solid 0px black"></canvas>
				</div>
			</div>

			<div style="float: left">
				<svg id="svgColorRamp" width="330" height="360" style="border: solid 1px black"></svg>
			</div>
			<div style="float: left; margin-left: 5px">
				<canvas id="fieldCanvas" width="513" height="513" style="border: solid 1px black"></canvas><br>
				<canvas id="fieldDiffCanvas" width="513" height="513" style="border: solid 1px black"></canvas>


			</div>
			<div style="margin-left: 5px; float: left; width: 120px; height:100px; border: solid 0px black">
				spatial frequency<div id="sliderScale" style="width: 80px; height: 5px; font-size: 10px"></div>
				<br>

				<label for="noiseSimplex">simplex</label>
				<input type="radio" name="noiseGen" id="noiseSimplex" checked="checked">
				<label for="noiseTerrain">terrain</label>
				<input type="radio" name="noiseGen" id="noiseTerrain">
			</div>
		</div>
	</div>

	<script type="text/javascript">

		var NOISE_SIMPLEX = 1;
		var NOISE_TERRAIN = 2;
		var noiseType = NOISE_SIMPLEX;
		var terrain = null;
		
		function refreshNoise() {
			switch (noiseType)
			{

			case NOISE_SIMPLEX:
				makeNoise(field, $('#sliderScale').slider('value'));
				break;
			case NOISE_TERRAIN:
				if (!terrain) {
					console.log("new terrain " + Math.log2(field.w-1));
					terrain = new Terrain(Math.log2(field.w-1), field.view);
				}
				terrain.generate(noiseScale*10);
				field.normalize();
				break;
			}

			visualizeScalarField(field);

		}

		function terrainNoise() {

			visualizeScalarField(field);
		}

		// create UI elements
		function createUI() {
			$('#sliderScale').slider({ step: 0.01, min: 0.01, max: 10, value: noiseScale, change: refreshNoise });

			// switch to different noise generators
			d3.select('#noiseSimplex').on('click', function() {
				noiseType = NOISE_SIMPLEX;
				refreshNoise();
			})
			d3.select('#noiseTerrain').on('click', function() {
				noiseType = NOISE_TERRAIN;
				refreshNoise();
			});
		}

		// function to re-draw scalar field
		var renderGL = true;	
		
		function visualizeScalarField(_field) 
		{
			var theField = _field || field			
			theField.setColorMap(ramp.getColorMap());

			if (renderGL) 
			{
				if (colorPipeline.ready()) {
					// compute color difference
					colorPipeline.run("speed");
					colorPipeline.copyToCanvas(d3.select("#fieldDiffCanvas").node());

					// visualize the field
					colorPipeline.run("vis");
				}
			} 
		}
		
		// color analysis pipeline
		var colorPipeline = null;
		function initColorAnalysis() {
			colorPipeline = new ColorAnalysis(field, d3.select("#fieldCanvas").node());
		}

	</script>

	<script type="text/javascript">
		var SHIFT=false;
		$(document).ready(function() 
		{
			$( "input" ).checkboxradio({
				icon: false
			});
		});

		// create a test scalar field, which we will fill with Simplex/Perlin noise
		var fieldCanvas = d3.select("#fieldCanvas").node();
		var field = new ScalarField(fieldCanvas.width, fieldCanvas.height);

		// create color picker
		var picker = new ColorPicker(
			d3.select("#colorCanvas").node(),
			d3.select("#channelCanvas").node()
		);

		// create color ramp
		var ramp = new ColorRamp(null, d3.select("#svgColorRamp"), picker);
		ramp.registerCallback(function() {
			visualizeScalarField(field);
		});


		// create noise
		seedNoise();
		makeNoise(field);

		// initialize color analysis pipeline
		initColorAnalysis();

		// visualize the initial field
		visualizeScalarField(field);

		createUI();

	</script>

</body>

</html>
